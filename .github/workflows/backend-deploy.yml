name: Deploy Backend (App Runner)

on:
  push:
    branches: ["main"]
    paths:
      - "backend/**"
      - "scripts/deploy_apprunner.py"
      - ".github/workflows/backend-deploy.yml"
  workflow_dispatch: {}

permissions:
  id-token: write
  contents: read

concurrency:
  group: backend-prod
  cancel-in-progress: true

jobs:
  deploy:
    name: Build + Push to ECR + Deploy App Runner
    runs-on: ubuntu-latest
    environment: prod
    timeout-minutes: 30

    steps:
      # ----------------------------
      # Checkout
      # ----------------------------
      - name: Checkout
        uses: actions/checkout@v4

      # ----------------------------
      # Debug OIDC token claims (TEMPORARY)
      # ----------------------------
      - name: Debug OIDC token claims (temporary)
        env:
          AUDIENCE: sts.amazonaws.com
        run: |
          set -euo pipefail

          echo "ACTIONS_ID_TOKEN_REQUEST_URL is set? $([ -n "${ACTIONS_ID_TOKEN_REQUEST_URL:-}" ] && echo yes || echo no)"
          echo "ACTIONS_ID_TOKEN_REQUEST_TOKEN is set? $([ -n "${ACTIONS_ID_TOKEN_REQUEST_TOKEN:-}" ] && echo yes || echo no)"

          if [ -z "${ACTIONS_ID_TOKEN_REQUEST_URL:-}" ] || [ -z "${ACTIONS_ID_TOKEN_REQUEST_TOKEN:-}" ]; then
            echo "OIDC request env vars missing â€” check workflow permissions"
            exit 1
          fi

          URL="${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=${AUDIENCE}"

          JWT="$(curl -sS \
            -H "Authorization: bearer ${ACTIONS_ID_TOKEN_REQUEST_TOKEN}" \
            "${URL}" \
            | python -c "import sys,json; print(json.load(sys.stdin)['value'])")"

          python - <<'PY'
          import json, base64

          jwt = """'"$JWT"'"""
          parts = jwt.split(".")
          if len(parts) != 3:
            raise SystemExit("Invalid JWT")

          def b64url_decode(s):
            s += "=" * (-len(s) % 4)
            return base64.urlsafe_b64decode(s.encode())

          payload = json.loads(b64url_decode(parts[1]).decode())
          keys = [
            "iss", "aud", "sub",
            "repository", "ref", "sha",
            "actor", "workflow", "job_workflow_ref",
            "environment", "event_name",
          ]
          print("Decoded OIDC token claims:")
          print(json.dumps({k: payload.get(k) for k in keys if k in payload}, indent=2))
          PY

      # ----------------------------
      # Configure AWS (OIDC)
      # ----------------------------
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      # ----------------------------
      # Python (for boto3 deploy)
      # ----------------------------
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install deploy dependencies
        run: |
          python -m pip install --upgrade pip
          pip install boto3

      # ----------------------------
      # Resolve AWS Account ID
      # ----------------------------
      - name: Resolve AWS Account ID
        id: acct
        run: |
          ACCOUNT_ID="$(aws sts get-caller-identity --query Account --output text)"
          echo "account_id=$ACCOUNT_ID" >> "$GITHUB_OUTPUT"

      # ----------------------------
      # Login to ECR
      # ----------------------------
      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      # ----------------------------
      # Image tag
      # ----------------------------
      - name: Set image tag
        id: tag
        run: |
          TS="$(date -u +%Y%m%d%H%M%S)"
          SHORT_SHA="${GITHUB_SHA::7}"
          echo "tag=${TS}-${SHORT_SHA}" >> "$GITHUB_OUTPUT"

      # ----------------------------
      # Build & Push Docker Image
      # ----------------------------
      - name: Build and push Docker image
        id: image
        working-directory: backend
        env:
          AWS_REGION: ${{ secrets.AWS_REGION }}
          ACCOUNT_ID: ${{ steps.acct.outputs.account_id }}
          ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}
          IMAGE_TAG: ${{ steps.tag.outputs.tag }}
        run: |
          IMAGE_URI="${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPOSITORY}:${IMAGE_TAG}"
          echo "Building: $IMAGE_URI"
          docker build -t "$IMAGE_URI" .
          docker push "$IMAGE_URI"
          echo "image_uri=$IMAGE_URI" >> "$GITHUB_OUTPUT"

      # ----------------------------
      # Deploy via boto3 (wait + health + rollback)
      # ----------------------------
      - name: Deploy via boto3 (wait + health + rollback)
        env:
          AWS_REGION: ${{ secrets.AWS_REGION }}
          APPRUNNER_SERVICE_ARN: ${{ secrets.APPRUNNER_SERVICE_ARN }}
          IMAGE_URI: ${{ steps.image.outputs.image_uri }}
          HEALTH_URL: ${{ secrets.BACKEND_HEALTH_URL }}
        run: |
          python scripts/deploy_apprunner.py \
            --region "$AWS_REGION" \
            --service-arn "$APPRUNNER_SERVICE_ARN" \
            --image-uri "$IMAGE_URI" \
            --health-url "$HEALTH_URL" \
            --timeout-seconds 900